<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Innocascade - Authentication</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body class="bg-gray-900">
    <header>
        <nav>
            <div class="logo">
                <div class="logo-text">Innocascade</div>
            </div>
            <div class="nav-links">
                <a href="index.php">Home</a>
                <a href="about.html">About</a>
                <a href="share_ideas.html">Share Ideas</a>
                <a href="chat.html">Chat</a>
                <a href="explore_ideas.html">Explore Ideas</a>
                <a href="leaderboard.html">Leaderboard</a>
                <a href="profile.html">Profile</a>
                <a href="admin.html" id="admin-link" class="hidden">Admin</a>
                <a href="auth.html#login" id="auth-link">Login</a>
            </div>
            <div class="hamburger">
                <div></div>
                <div></div>
                <div></div>
            </div>
        </nav>
        <div class="mobile-menu" id="mobile-menu">
            <a href="index.php">Home</a>
            <a href="about.html">About</a>
            <a href="share_ideas.html">Share Ideas</a>
            <a href="chat.html">Chat</a>
            <a href="explore_ideas.html">Explore Ideas</a>
            <a href="leaderboard.html">Leaderboard</a>
            <a href="profile.html">Profile</a>
            <a href="admin.html" id="mobile-admin-link" class="hidden">Admin</a>
            <a href="auth.html#login" id="mobile-auth-link">Login</a>
        </div>
    </header>

    <section class="min-h-screen py-16 flex items-center justify-center">
        <div class="container">
            <!-- Login Form -->
            <div id="login" class="form-card max-w-md mx-auto p-8 fade-in">
                <h2 class="text-3xl font-bold gradient-text mb-6 text-center">Login</h2>
                <form id="login-form" class="space-y-6">
                    <input type="hidden" name="csrf_token" id="login-csrf-token">
                    <div class="input-group">
                        <input type="email" name="email" id="login-email" required class="input-field pr-10" placeholder="Email" autocomplete="email">
                        <i class="fas fa-envelope absolute top-3 left-3 text-gray-400"></i>
                    </div>
                    <div class="input-group">
                        <input type="password" name="password" id="login-password" required class="input-field pr-10" placeholder="Password" autocomplete="current-password">
                        <i class="fas fa-lock absolute top-3 left-3 text-gray-400"></i>
                        <button type="button" class="toggle-password absolute top-3 right-3 text-gray-400 hover:text-orange-500" onclick="togglePassword('login-password', this)">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <div class="flex items-center justify-between">
                        <label class="flex items-center gap-2 text-gray-300">
                            <input type="checkbox" name="remember" id="remember" class="accent-orange-500">
                            Remember Me
                        </label>
                        <a href="forgot.html" class="text-orange-500 hover:text-orange-400">Forgot Password?</a>
                    </div>
                    <button type="submit" class="w-full gradient-button text-white py-3 rounded-lg font-semibold">
                        <span>Login</span>
                        <i class="fas fa-spinner fa-spin ml-2 hidden"></i>
                    </button>
                </form>
                <p class="mt-6 text-center text-gray-300">
                    Don't have an account? <a href="auth.html#signup" class="text-orange-500 hover:text-orange-400">Sign Up</a>
                </p>
            </div>

            <!-- Signup Form -->
            <div id="signup" class="form-card max-w-md mx-auto p-8 fade-in hidden">
                <h2 class="text-3xl font-bold gradient-text mb-6 text-center">Sign Up</h2>
                <form id="signup-form" class="space-y-6">
                    <input type="hidden" name="csrf_token" id="signup-csrf-token">
                    <div class="input-group">
                        <input type="text" name="username" id="signup-username" required class="input-field pr-10" placeholder="Username" autocomplete="username">
                        <i class="fas fa-user absolute top-3 left-3 text-gray-400"></i>
                    </div>
                    <div class="input-group">
                        <input type="email" name="email" id="signup-email" required class="input-field pr-10" placeholder="Email" autocomplete="email">
                        <i class="fas fa-envelope absolute top-3 left-3 text-gray-400"></i>
                    </div>
                    <div class="input-group">
                        <input type="password" name="password" id="signup-password" required class="input-field pr-10" placeholder="Password" autocomplete="new-password">
                        <i class="fas fa-lock absolute top-3 left-3 text-gray-400"></i>
                        <button type="button" class="toggle-password absolute top-3 right-3 text-gray-400 hover:text-orange-500" onclick="togglePassword('signup-password', this)">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <button type="submit" class="w-full gradient-button text-white py-3 rounded-lg font-semibold">
                        <span>Sign Up</span>
                        <i class="fas fa-spinner fa-spin ml-2 hidden"></i>
                    </button>
                </form>
                <p class="mt-6 text-center text-gray-300">
                    Already have an account? <a href="index.php" class="text-orange-500 hover:text-orange-400">Login</a>
                </p>
            </div>
        </div>
    </section>

    <footer>
        <div class="footer-content">
            <p>Â© 2025 Innocascade. All rights reserved.</p>
            <div class="footer-links">
                <a href="index.php">Home</a>
                <a href="about.html">About</a>
                <a href="contact.html">Contact</a>
                <a href="#">Privacy Policy</a>
                <a href="#">Terms of Service</a>
            </div>
            <div class="social-icons">
                <a href="#"><i class="fab fa-twitter"></i></a>
                <a href="#"><i class="fab fa-linkedin-in"></i></a>
                <a href="#"><i class="fab fa-instagram"></i></a>
                <a href="#"><i class="fab fa-github"></i></a>
            </div>
        </div>
    </footer>

    <div id="notification" class="notification hidden"></div>

    <script src="js/scripts.js"></script>
    <script>
        function togglePassword(inputId, button) {
            const input = document.getElementById(inputId);
            const icon = button.querySelector('i');
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.replace('fa-eye', 'fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.replace('fa-eye-slash', 'fa-eye');
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // Set CSRF tokens for both forms
            const loginCsrfToken = document.getElementById('login-csrf-token');
            const signupCsrfToken = document.getElementById('signup-csrf-token');
            try {
                const csrfToken = await fetchCsrfToken();
                loginCsrfToken.value = csrfToken;
                signupCsrfToken.value = csrfToken;
            } catch (error) {
                console.error('Failed to set CSRF token:', error);
                showNotification('Failed to initialize form. Please try again.', 'error');
            }

            // Handle hash-based form switching
            function showForm(formId) {
                document.getElementById('login').classList.add('hidden');
                document.getElementById('signup').classList.add('hidden');
                document.getElementById(formId).classList.remove('hidden');
            }

            if (window.location.hash === '#signup') {
                showForm('signup');
            } else {
                showForm('login');
            }

            window.addEventListener('hashchange', () => {
                if (window.location.hash === '#signup') {
                    showForm('signup');
                } else {
                    showForm('login');
                }
            });

            // Handle login form submission
            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const button = form.querySelector('button');
                const spinner = button.querySelector('.fa-spinner');
                button.disabled = true;
                spinner.classList.remove('hidden');

                const formData = new FormData(form);
                try {
                    const response = await fetch('backend/auth/login.php', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await response.json();
                    showNotification(data.message, data.success ? 'success' : 'error');
                    if (data.success) {
                        sessionStorage.setItem('user_id', data.user_id);
                        // Use absolute URL for redirection
                        setTimeout(() => {
                            window.location.href = '/innocascade/index.php';
                        }, 1000);
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    showNotification('Failed to login. Please try again.', 'error');
                } finally {
                    button.disabled = false;
                    spinner.classList.add('hidden');
                }
            });

            // Handle signup form submission
            document.getElementById('signup-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const button = form.querySelector('button');
                const spinner = button.querySelector('.fa-spinner');
                button.disabled = true;
                spinner.classList.remove('hidden');

                const formData = new FormData(form);
                try {
                    const response = await fetch('backend/auth/signup.php', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await response.json();
                    showNotification(data.message, data.success ? 'success' : 'error');
                    if (data.success) {
                        sessionStorage.setItem('user_id', data.user_id);
                        // Use absolute URL for redirection
                        setTimeout(() => {
                            window.location.href = '/innocascade/index.php';
                        }, 1000);
                    }
                } catch (error) {
                    console.error('Signup error:', error);
                    showNotification('Failed to sign up. Please try again.', 'error');
                } finally {
                    button.disabled = false;
                    spinner.classList.add('hidden');
                }
            });
        });
    </script>
</body>
</html>